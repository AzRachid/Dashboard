<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Scoring Crédit</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            max-width: 800px;
            margin: auto;
        }
        button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        select {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            font-size: 16px;
        }
        pre {
            background-color: #f4f4f4;
            padding: 10px;
            border: 1px solid #ddd;
            margin-top: 20px;
        }
        img {
            max-width: 100%;
            height: auto;
        }
        #gauge-container {
            text-align: center;
            margin-top: 20px;
        }
        canvas {
            display: block;
            margin: 0 auto;
        }
    </style>
    <!-- Ajouter Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h1>Dashboard Scoring Crédit</h1>

        <!-- Boutons pour choisir les fonctions -->
        <h2>Sélectionnez un client</h2>
        <button onclick="fetchClients()">Charger la liste des clients</button>
        <select id="client-id" disabled></select>

        <!-- Prédiction -->
        <button onclick="predictClient()" id="predict-btn" disabled>Prédire</button>
        <div id="prediction-results"></div>
        <div id="gauge-container"></div>

        <!-- Graphiques -->
        <h2>Graphiques</h2>
        <button onclick="fetchGlobalImportance()">Importance Globale</button>
        <button onclick="fetchLocalImportance()" id="local-btn" disabled>Importance Locale</button>
        <button onclick="fetchDistribution()">Distribution de Variable</button>
        <img id="chart" src="" alt="Chart">

        <!-- Sélection de variable pour distribution -->
        <label for="variable-select">Sélectionnez une variable :</label>
        <select id="variable-select" disabled></select>
    </div>

    <script>
        let clientList = [];
        let featureNames = []; // Liste des features

        // Charger la liste des clients
        function fetchClients() {
            fetch("/clients")
                .then(response => response.json())
                .then(data => {
                    const clientIdSelect = document.getElementById("client-id");
                    clientIdSelect.innerHTML = ""; // Effacer les options existantes
                    data.forEach(clientId => {
                        const option = document.createElement("option");
                        option.value = clientId;
                        option.textContent = clientId;
                        clientIdSelect.appendChild(option);
                    });
                    clientIdSelect.disabled = false; // Activer la liste déroulante
                    document.getElementById("predict-btn").disabled = false;
                    document.getElementById("local-btn").disabled = false;

                    // Récupérer les noms des features
                    fetch("/global-importance")
                        .then(response => response.json())
                        .then(data => {
                            const globalImportance = atob(data.image); // Décoder l'image base64
                            const analyzerResponse = JSON.parse(globalImportance); // Analyser la réponse
                            featureNames = analyzerResponse.global_importance_names || [];
                            populateVariableDropdown();
                        })
                        .catch(error => console.error("Erreur lors du chargement des features :", error));
                })
                .catch(error => console.error("Erreur lors du chargement des clients :", error));
        }

        // Remplir la liste déroulante des variables
        function populateVariableDropdown() {
            const variableSelect = document.getElementById("variable-select");
            variableSelect.innerHTML = ""; // Effacer les options existantes
            featureNames.forEach(feature => {
                const option = document.createElement("option");
                option.value = feature;
                option.textContent = feature;
                variableSelect.appendChild(option);
            });
            variableSelect.disabled = false; // Activer la liste déroulante
        }

        // Prédiction pour un client
        function predictClient() {
            const clientId = document.getElementById("client-id").value;
            if (!clientId) {
                alert("Veuillez sélectionner un ID client.");
                return;
            }
            fetch(`/predict/${clientId}`)
                .then(response => response.json())
                .then(data => {
                    const decision = data.decision || "Indéterminé";
                    const score = data.score || 0;

                    // Afficher la décision
                    document.getElementById("prediction-results").innerHTML = `
                        <strong>Décision :</strong> ${decision}<br>
                        <strong>Score :</strong> ${score.toFixed(4)}
                    `;

                    // Créer la jauge
                    createGauge(score);
                })
                .catch(error => alert("Erreur lors de la prédiction."));
        }

        // Créer une jauge avec Chart.js
        function createGauge(score) {
            const ctx = document.getElementById('gauge').getContext('2d');
            const gaugeCanvas = document.getElementById('gauge');
            if (!gaugeCanvas) {
                const gaugeContainer = document.getElementById('gauge-container');
                gaugeContainer.innerHTML = '<canvas id="gauge" width="300" height="300"></canvas>';
            }

            const threshold = 0.51;

            // Configurer la jauge
            const gaugeConfig = {
                type: 'doughnut',
                data: {
                    labels: ['Score', 'Reste'],
                    datasets: [{
                        data: [(1 - score) * 100, score * 100], // Inversé pour proche de 0 = accepté
                        backgroundColor: ['#4caf50', '#f44336'], // Vert pour accepté, rouge pour refusé
                        borderColor: ['#4caf50', '#f44336'],
                        borderWidth: 1
                    }]
                },
                options: {
                    cutoutPercentage: 80,
                    rotation: Math.PI * -0.5,
                    circumference: Math.PI * 2,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            };

            // Configurer le seuil
            const thresholdConfig = {
                type: 'doughnut',
                data: {
                    labels: ['Seuil', 'Reste'],
                    datasets: [{
                        data: [threshold * 100, (1 - threshold) * 100],
                        backgroundColor: ['#ffeb3b', 'transparent'], // Jaune pour le seuil
                        borderColor: ['#ffeb3b', 'transparent'],
                        borderWidth: 1
                    }]
                },
                options: {
                    cutoutPercentage: 90,
                    rotation: Math.PI * -0.5,
                    circumference: Math.PI * 2,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            };

            // Créer les jauges
            new Chart(ctx, gaugeConfig);
            new Chart(ctx, thresholdConfig);

            // Afficher le seuil au centre
            const centerText = document.createElement('p');
            centerText.style.position = 'absolute';
            centerText.style.top = '50%';
            centerText.style.left = '50%';
            centerText.style.transform = 'translate(-50%, -50%)';
            centerText.style.fontSize = '20px';
            centerText.style.fontWeight = 'bold';
            centerText.textContent = `Seuil : ${threshold}`;
            document.getElementById('gauge-container').appendChild(centerText);
        }

        // Récupérer l'importance globale
        function fetchGlobalImportance() {
            fetch("/global-importance")
                .then(response => response.json())
                .then(data => {
                    document.getElementById("chart").src = "data:image/png;base64," + data.image;
                })
                .catch(error => alert("Erreur lors du chargement de l'importance globale."));
        }

        // Récupérer l'importance locale
        function fetchLocalImportance() {
            const clientId = document.getElementById("client-id").value;
            if (!clientId) {
                alert("Veuillez sélectionner un ID client.");
                return;
            }
            fetch(`/local-importance/${clientId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById("chart").src = "data:image/png;base64," + data.image;
                })
                .catch(error => alert("Erreur lors du chargement de l'importance locale."));
        }

        // Récupérer la distribution d'une variable
        function fetchDistribution() {
            const variable = document.getElementById("variable-select").value;
            if (!variable) {
                alert("Veuillez sélectionner une variable.");
                return;
            }
            fetch(`/distribution/${variable}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById("chart").src = "data:image/png;base64," + data.image;
                })
                .catch(error => alert("Erreur lors du chargement de la distribution."));
        }
    </script>
</body>
</html>
